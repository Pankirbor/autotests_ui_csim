name: UI Tests & Allure Report

# –¢—Ä–∏–≥–≥–µ—Ä—ã: push –∏ PR –≤ main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
env:
  PYTHON_VERSION: "3.11"
  ALLURE_RESULTS_DIR: "./allure-ui-results"
  ALLURE_REPORT_DIR: "./allure-ui-report"
  ALLURE_HISTORY_DIR: "./allure-ui-history"

jobs:

  # üß™ –ó–∞–ø—É—Å–∫ UI-—Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ Playwright
  ui-tests:
    runs-on: ubuntu-latest
    steps:

      # 1. Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ pip-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏)
      - name: üíæ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
      - name: üíæ Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-browsers

      # 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      - name: üêç Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 5. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (–ª–æ–≥–∏, –≤–∏–¥–µ–æ, –æ—Ç—á—ë—Ç—ã –∏ —Ç.–¥.)
      - name: üóÇÔ∏è Create required directories
        run: |
          mkdir -p ${{ env.ALLURE_RESULTS_DIR }} videos tracing logs
          touch browser_state.json
          echo "‚úÖ Directories and files created"

      # 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π + Playwright
      - name: üì¶ Install dependencies and Playwright
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps

      # 7. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π Allure-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      - name: üß™ Run UI tests with pytest
        run: |
          pytest -m UI \
            --alluredir=${{ env.ALLURE_RESULTS_DIR }} \
            --numprocesses=2 \


      # 8. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏)
      - name: üì§ Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-ui-results
          path: ${{ env.ALLURE_RESULTS_DIR }}

  # üìä –ü—É–±–ª–∏–∫–∞—Ü–∏—è Allure-–æ—Ç—á—ë—Ç–∞ –Ω–∞ GitHub Pages
  publish-report:
    name: üìà Publish Allure Report to GitHub Pages
    needs: ui-tests
    if: always()
    runs-on: ubuntu-latest
    steps:

      # 1. Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–æ—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞)
      - name: üì• Checkout main branch
        uses: actions/checkout@v4

      # 2. –°–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
      - name: üì• Download Allure results from ui-tests job
        uses: actions/download-artifact@v4
        with:
          name: allure-ui-results
          path: ${{ env.ALLURE_RESULTS_DIR }}

      # 3. Checkout –≤–µ—Ç–∫–∏ gh-pages (–µ—Å–ª–∏ –µ—Å—Ç—å) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
      #    continue-on-error: true ‚Äî –µ—Å–ª–∏ –≤–µ—Ç–∫–∏ –Ω–µ—Ç, –Ω–µ –ø–∞–¥–∞–µ–º
      - name: üì• Checkout gh-pages branch for history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure-–æ—Ç—á—ë—Ç–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      - name: üìä Generate Allure Report with history support
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: ${{ env.ALLURE_RESULTS_DIR }}
          allure_report: ${{ env.ALLURE_REPORT_DIR }}
          allure_history: ${{ env.ALLURE_HISTORY_DIR }}

      # # 5. –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      # - name: üîÑ Copy previous history into report
      #   run: |
      #     mkdir -p ${{ env.ALLURE_HISTORY_DIR }}
      #     if [ -d "gh-pages/history" ]; then
      #       cp -r gh-pages/history/* ${{ env.ALLURE_HISTORY_DIR }}/ 2>/dev/null || echo "‚ö†Ô∏è No files to copy from previous history"
      #       echo "‚úÖ Copied previous history for trends"
      #     else
      #       echo "‚ÑπÔ∏è No previous history found ‚Äî starting fresh"
      #     fi

      # 6. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –≤ –≤–µ—Ç–∫—É gh-pages
      - name: üöÄ Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ env.ALLURE_HISTORY_DIR }}

      # 7. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í—ã–≤–æ–¥ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç—á—ë—Ç
      - name: üîó Print report URL
        run: |
          echo "‚úÖ Allure Report published!"
          echo "üëâ View report at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"